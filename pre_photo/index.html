<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
	</head>
	<body>
	</body>
	<script>
		function handleThumb(e){
        var file = e.target.files[0];

        if (file) {
            if (/^image\//i.test(file.type)) {

                var reader = new FileReader();
                showLoadingDialog('');

                reader.onloadend = function () {
                    var img = new Image();

                    img.onload = function () {
                        //var w = Math.min(400, img.width);
                        //var h = img.height * (w / img.width);
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');


                        ////////////////////////////////////////////////////////////////////////////
                        var exif;
                        if (typeof EXIF != 'undefined'){
                            exif = parseInt(EXIF.getTag(img, "Orientation"));
                        }
                        
                        //当图片宽度超过 400px 时, 就压缩成 400px, 高度按比例计算
                        canvas.width = Math.min(400, img.width);
                        //0 -> 0 =|
                        if(exif==1){
                            alert('exif == 1');
                            canvas.height = canvas.width * (img.height / img.width);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        }
                        // if(orientation == 270){ //_||_
                        else if(exif==6){ //[_]
                            alert('exif == 6');
                            canvas.height = canvas.width * (img.width / img.height);
                            ctx.translate(canvas.width, 0);
                            ctx.rotate(0.5 * Math.PI);
                            ctx.drawImage(img, 0, 0, canvas.height, canvas.width);
                        }
                        //180 -> 0 |=
                        else if(exif==3){
                            alert('exif == 3');
                            canvas.height = canvas.width * (img.height / img.width);
                            ctx.translate(canvas.width, canvas.height);
                            ctx.rotate(1 * Math.PI);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        }
                        //selfie
                        else if(exif==8){ //[_]
                            alert('exif == 8');
                            canvas.height = canvas.width * (img.width / img.height);
                            ctx.translate(0, canvas.height);
                            ctx.rotate(-0.5 * Math.PI);
                            ctx.drawImage(img, 0, 0, canvas.height, canvas.width);
                        }
                        else { //desktop\
                            alert('exif == NAN');
                            canvas.height = canvas.width * (img.height / img.width);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        }

                            ////////////////////////////////////////////////////////////////////////////



                        //// 设置 canvas 的宽度和高度
                        //canvas.width = w;
                        //canvas.height = h;
                        //
                        //// 把图片绘制到 canvas 中
                        //ctx.drawImage(img, 0, 0, w, h);

                        // 取出 base64 格式数据
                        var dataURL = canvas.toDataURL('image/png');

                        $('<li class="weui_uploader_file" style="background-image:url(' + dataURL + ')"></li>').appendTo('.weui_uploader_files');
                        files.push({
                            name: file.name,
                            dataURL: dataURL
                        });

                        // 压缩后大小
                        var after = dataURItoBlob(dataURL);
                        console.log('after compress', after.size / 1024);
                        hideLoadingDialog();
                    };

                    // 压缩前大小
                    var before = dataURItoBlob(reader.result);
                    console.log('before compress', before.size / 1024);

                    img.src = reader.result;

                };

                reader.onerror = function () {
                    console.error('reader error');
                    hideLoadingDialog();
                };

                // 读出base64格式
                reader.readAsDataURL(file);
            } else {
                throw '只能上传图片';
            }
        }
    }
	</script>
</html>
